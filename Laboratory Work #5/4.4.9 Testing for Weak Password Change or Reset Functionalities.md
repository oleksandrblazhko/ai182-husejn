# Тестування слабкішої автентифікації в альтернативному каналі

|ID          |
|------------|
|WSTG-ATHN-09|

# Резюме

Для будь-якої програми, яка вимагає від користувача автентифікації за допомогою пароля, повинен існувати механізм, за допомогою якого користувач може відновити доступ до свого облікового запису, якщо він забуде свій пароль. Хоча іноді це може бути ручний процес, який передбачає зв’язок із власником веб-сайту або командою підтримки, користувачам часто дозволяється самостійно скинути пароль і відновити доступ до свого облікового запису, надавши інші докази своєї особи. .

Оскільки ця функція забезпечує прямий шлях до компрометації облікового запису користувача, дуже важливо, щоб вона була реалізована безпечно.

# Цілі тесту

- Визначте, чи дозволяє функція зміни та скидання пароля зламати облікові записи.

# Як тестувати

### Збір інформації

Першим кроком є збір інформації про те, які механізми доступні, щоб дозволити користувачеві скинути свій пароль у програмі. Якщо на одному сайті є кілька інтерфейсів (наприклад, веб-інтерфейс, мобільний додаток і API), їх слід переглянути, якщо вони надають різні функції.

Коли це буде встановлено, визначте, яка інформація потрібна для того, щоб користувач ініціював скидання пароля. Це може бути ім’я користувача чи адреса електронної пошти (обидва вони можуть бути отримані з загальнодоступної інформації), але це також може бути внутрішньо згенерований ідентифікатор користувача.

### Загальні проблеми

Незалежно від конкретних методів, які використовуються для скидання паролів, існує ряд загальних моментів, які необхідно враховувати:

- Чи процес скидання пароля слабший за процес автентифікації?
    
    Процес скидання пароля забезпечує альтернативний механізм доступу до облікового запису користувача, тому має бути принаймні таким же безпечним, як і звичайний процес автентифікації. Однак це може надати простіший спосіб скомпрометувати обліковий запис, особливо якщо він використовує слабші фактори автентифікації, такі як питання безпеки.

    Крім того, процес скидання пароля може обійти вимогу використовувати багатофакторну автентифікацію (MFA), що може суттєво знизити безпеку програми.
    
- Чи існує обмеження швидкості чи інший захист від автоматизованих атак?
    
    Як і будь-який механізм автентифікації, процес скидання пароля повинен мати захист від автоматизованих атак або атак грубої сили. Для цього можна використовувати різні методи, як-от обмеження швидкості або використання CAPTCHA. Це особливо важливо для функцій, які запускають зовнішні дії (наприклад, надсилання електронного листа чи SMS), або коли користувач вводить маркер скидання пароля.

    Також можна захиститися від атак грубою силою, заблокувавши обліковий запис у процесі скидання пароля після певної кількості послідовних спроб. Однак це також може перешкодити законному користувачеві скинути свій пароль і відновити доступ до свого облікового запису.
    
- Чи вразливий він до типових атак?
  
  Крім конкретних областей, розглянутих у цьому посібнику, також важливо перевірити інші поширені вразливості, такі як впровадження SQL або міжсайтовий сценарій.
  
### Електронна пошта - новий пароль надіслано

У цій моделі користувачеві надсилається новий пароль електронною поштою після підтвердження своєї особи. Це вважається менш безпечним з двох основних причин:

- Пароль надсилається користувачеві в незашифрованому вигляді.
- Пароль облікового запису змінюється, коли надсилається запит, фактично блокуючи користувача з його облікового запису, доки він не отримає електронний лист. Здійснюючи повторні запити, можна заборонити користувачеві отримати доступ до свого облікового запису.

Якщо використовується цей підхід, слід переглянути такі сфери:

- Чи змушений користувач змінювати пароль під час першого входу?

    Новий пароль надсилається через незашифровану електронну пошту та може залишатися в папці "Вхідні" користувача необмежений час, якщо він не видалить електронний лист. Таким чином, користувач повинен змінити пароль, як тільки він увійде в систему вперше.
- Чи безпечно згенерований пароль?

    Пароль має бути згенерований за допомогою криптографічно захищеного генератора псевдовипадкових чисел (CSPRNG) і має бути достатньо довгим, щоб запобігти вгадуванню пароля або атакам грубої сили. Для безпечного зручного використання його слід створити за допомогою безпечного підходу у вигляді парольної фрази (тобто поєднання кількох слів), а не рядка випадкових символів.

- Чи надіслано їм існуючий пароль користувача?

    Замість того, щоб генерувати новий пароль для користувача, деякі програми надішлють користувачеві свій існуючий пароль. Це дуже небезпечний підхід, оскільки він розкриває поточний пароль через незашифровану електронну пошту. Крім того, якщо сайт може відновити існуючий пароль, це означає, що паролі або зберігаються за допомогою оборотного шифрування, або (швидше) у незашифрованому відкритому тексті, обидва з яких представляють серйозну слабкість безпеки.

- Чи надіслані електронні листи з домену мають захист від спуфінгу?

    Домен повинен використовувати SPF, DKIM і DMARC, щоб зловмисники не могли підробити електронні листи з нього, що може бути використано як частина атаки соціальної інженерії.

- Чи вважається електронна пошта достатньо безпечною?

    Електронні листи зазвичай надсилаються незашифрованими, і в багатьох випадках обліковий запис електронної пошти користувача не захищається MFA. Він також може використовуватися між кількома особами, особливо в корпоративному середовищі.

Подумайте, чи підходить функція скидання пароля за допомогою електронної пошти, виходячи з контексту програми, яка тестується.

### Електронна пошта – посилання надіслано

У цій моделі користувачеві електронною поштою надсилається посилання, яке містить маркер. Потім вони можуть натиснути це посилання, і їм буде запропоновано ввести новий пароль на сайті. Це найпоширеніший підхід, який використовується для скидання пароля, але його реалізація складніша, ніж підхід, який обговорювався раніше. Ключові області для тестування:

- Чи використовує посилання HTTPS?

    Якщо маркер надсилається через незашифрований HTTP, зловмисник може його перехопити.

- Чи можна використовувати посилання кілька разів?

    Термін дії посилань має закінчитися після їх використання, інакше вони створюють постійний бекдор для облікового запису.

- Чи закінчується термін дії посилання, якщо воно залишається невикористаним?

    Посилання мають бути обмежені за часом. Скільки часу буде доцільним, залежить від сайту, але рідко воно має тривати більше години.
- Чи є маркер достатньо довгим і випадковим?

    Безпека процесу повністю залежить від того, що зловмисник не зможе вгадати або підібрати токен. Токени мають бути згенеровані за допомогою криптографічно захищеного генератора псевдовипадкових чисел (CSPRNG) і мають бути достатньо довгими, щоб зловмиснику було непрактично вгадати чи застосувати грубу силу. Принаймні 128 біт (або 32 шістнадцяткові символи) є достатнім мінімумом, щоб зробити таку онлайн-атаку непрактичною.
    
    Токени ніколи не повинні генеруватися на основі відомих значень, наприклад шляхом використання хешу MD5 електронної пошти користувача з `md5($email)`, або використання GUID, які можуть використовувати незахищені функції PRNG, або можуть навіть не бути випадковими залежно від типу.

    Альтернативним підходом до випадкових токенів є використання криптографічно підписаного токена, такого як JWT. У цьому випадку слід виконати звичайні перевірки JWT (чи перевірено підпис, чи можна використати алгоритм «none», чи можна підібрати ключ HMAC підбір тощо).
   
- Чи містить посилання ідентифікатор користувача?

  Іноді посилання для скидання пароля може містити ідентифікатор користувача, а також маркер, наприклад `reset.php?userid=1&token=123456`. У цьому випадку можна змінити `userid` параметр для скидання паролів інших користувачів.
  
- Чи можете ви ввести інший заголовок хоста?
  
  Якщо програма довіряє значенню `Host` заголовок і використовує його для генерації посилання для скидання пароля, можливо, викрасти токени шляхом введення модифікованого `Host` заголовок у запит.
  
- Чи доступне посилання для третіх осіб?
  
  Якщо сторінка, на яку переходить користувач, включає вміст інших сторін (наприклад, завантаження сценаріїв з інших доменів), то маркер скидання в URL-адресі може бути відкритий у HTTP `Referer` заголовок, надісланий у цих запитах. The `Referrer-Policy` Заголовок HTTP можна використовувати для захисту від цього, тому перевірте, чи визначено його для сторінки.
  
  Крім того, якщо сторінка містить будь-які сценарії відстеження, аналітики чи реклами, маркер також буде відкритий для них.
  
- Чи надіслані електронні листи з домену мають захист від спуфінгу?
  
  Домен повинен використовувати SPF, DKIM і DMARC, щоб зловмисники не могли підробити електронні листи з нього, що може бути використано як частина атаки соціальної інженерії.
  
- Чи вважається електронна пошта достатньо безпечною?

  Електронні листи зазвичай надсилаються незашифрованими, і в багатьох випадках обліковий запис електронної пошти користувача не захищається MFA. Він також може використовуватися між кількома особами, особливо в корпоративному середовищі.
  
  Подумайте, чи підходить функція скидання пароля за допомогою електронної пошти, виходячи з контексту програми, яка тестується.
 
### Жетони, надіслані через SMS або телефонний дзвінок

Замість того, щоб надсилати маркер електронною поштою, альтернативним підходом є надсилання його через SMS або автоматичний телефонний дзвінок, який користувач потім вводить у програмі. Ключові області для тестування:

- Чи є маркер достатньо довгим і випадковим?
  
  Маркери, надіслані таким чином, зазвичай коротші, оскільки призначені для введення користувачем вручну, а не для вбудовування в посилання. Досить часто для програм використовують шість цифрових цифр, що забезпечує лише ~20 біт безпеки (можливо для онлайн-атаки грубої сили), а не зазвичай довший маркер електронної пошти.

  Це робить набагато важливішим, щоб функція скидання пароля була захищена від атак грубої сили.

- Чи можна використовувати маркер кілька разів?

  Токени мають бути визнані недійсними після їх використання, інакше вони створюють постійний бекдор для облікового запису.

- Чи закінчується термін дії токена, якщо він залишається невикористаним?

  Оскільки коротші токени більш сприйнятливі до атак грубою силою, слід запровадити коротший час закінчення, щоб обмежити вікно, доступне для зловмисника для здійснення атаки.

- Чи діють відповідні обмеження та обмеження щодо ставок?

  Надсилання SMS або ініціювання автоматичного телефонного дзвінка користувачеві є значно більш руйнівним, ніж надсилання електронного листа, і може бути використано для переслідування користувача або навіть для здійснення атаки на його телефон. Щоб запобігти цьому, програма має запровадити обмеження швидкості.

  Крім того, SMS-повідомлення та телефонні дзвінки часто спричиняють фінансові витрати для відправника. Якщо зловмисник зможе надіслати велику кількість повідомлень, це може призвести до значних витрат для оператора веб-сайту. Це особливо вірно, якщо вони надсилаються на міжнародні номери або номери з преміум-тарифом. Однак дозволити міжнародні номери може бути вимогою програми.

- Чи вважаються SMS або телефонний дзвінок достатньо безпечними?

  [Різноманітність атак](https://www.ncsc.gov.uk/guidance/protecting-sms-messages-used-in-critical-business-processes#section_4) Було продемонстровано, що дозволило б зловмиснику ефективно викрадати SMS-повідомлення, існують суперечливі погляди щодо того, чи є SMS достатньо безпечним для використання як фактор автентифікації.
  
  Зазвичай можна відповісти на автоматичний телефонний дзвінок за допомогою фізичного доступу до пристрою, не потребуючи PIN-коду чи відбитка пальця для розблокування телефону. У деяких випадках (наприклад, у спільному офісному середовищі) це може дозволити внутрішньому зловмиснику тривіально скинути пароль іншого користувача, підійшовши до його робочого столу, коли його немає в офісі.
  
  Подумайте, чи підходять SMS або автоматичні телефонні дзвінки, виходячи з контексту програми, яка тестується.
  
### Питання безпеки

Замість того, щоб надсилати їм посилання чи новий пароль, питання безпеки можна використовувати як механізм для автентифікації користувача. Це вважається слабким підходом, і його не слід використовувати, якщо доступні кращі варіанти.

### Автентифіковані зміни пароля

Коли користувач підтвердить свою особу (через посилання для скидання пароля, код відновлення або ввійшовши в програму), він зможе змінити свій пароль. Ключові області для тестування:

- Під час встановлення пароля чи можете ви вказати ідентифікатор користувача?

    Якщо ідентифікатор користувача включений у запит на скидання пароля та не перевірений, можливо, його можна змінити та змінити паролі інших користувачів.

- Чи вимагається від користувача повторна автентифікація?

    Якщо користувач, який увійшов у систему, намагається змінити свій пароль, його слід попросити повторно пройти автентифікацію за допомогою поточного пароля, щоб захистити зловмисника від отримання тимчасового доступу до сеансу без нагляду. Якщо користувач увімкнув MFA, він зазвичай повторно автентифікується за допомогою цього, а не свого пароля.
    
- Чи є форма зміни пароля вразливою до CSRF?

    Якщо від користувача не вимагається повторна автентифікація, можливо, буде здійснено CSRF-атаку на форму скидання пароля, що дозволить зламати його обліковий запис.

- Чи застосована надійна та ефективна політика паролів?

    Політика паролів має бути узгодженою для всіх функцій реєстрації, зміни пароля та скидання пароля.
    
# Посилання

- [Шпаргалка OWASP забув пароль](https://cheatsheetseries.owasp.org/cheatsheets/Forgot_Password_Cheat_Sheet.html)


  
